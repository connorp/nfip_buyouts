---
title: Flood Insurance Impact on Post-Flood Home Sales
author: Connor P. Jackson
date: "`r format(Sys.time(), '%B %d, %Y - %H:%M %Z')`"
output:
pdf_document:
    fig_caption: yes
    toc: yes
    number_sections: yes
    df_print: kable
  html_notebook:
    fig_caption: yes
    number_sections: yes
    df_print: kable
  html_document:
    code_folding: show
    fig_caption: yes
    highlight: textmate
    number_sections: yes
    toc: yes
    toc_depth: 2
    toc_float: yes
    df_print: kable
linestretch:
fontsize:
linkcolor: blue
urlcolor: blue
---

```{r setup, include=FALSE}
library(knitr)
library(rmarkdown)
library(stargazer)
library(sandwich)
library(plm)
options(knitr.kable.NA = '')
```

```{r initialize-data, include=FALSE}
source("merge_and_analysis.R")
```

# Introduction



# Data

## Flood Insurance Policies and Claims

Summary stats table of policies and claims

Show a graph of the first stage: number (or percentage) of policies by year, adapted vs nonadapted

## Housing Assessment and Transactions

First page footnote: Data provided by Zillow through the Zillow Transaction and Assessment Dataset (ZTRAX). More information on accessing the data can be found at <http://www.zillow.com/ztrax>. The results and opinions are those of the author and do not reflect the position of Zillow Group.

Summary stats table of homes and transactions

Show transaction probability over time (by year and relative to floods), split by adapted and non-adapted

## Constructed Panel

description of panel construction, sample size

# Model

Fixed effects regressions: OLS and IV, 2 vs 3 lag, lead vs no lead. 8 regressions total
Also include a first stage regression
Cluster at the census tract level (or at the county level?)

identifying assumptions
- flood probability is exogenous conditional on census tract, flood zone, adaptation status
- any time trends in transaction probability are common to adapted and non-adapted homes

Questions of interest:

1. Are homeowners more likely to sell following a flood event in their area (not looking at damage to specific homes)
2. Does holding a flood insurance policy mediate this effect (instrumenting for insurance takeup with exogenous policy shocks driving price changes)

Empirical method: event study, looking at flood events up to 3 years prior, and whether they held flood insurance in the year of the flood. Y variable is transaction probability in a given year. Currently running linear probability model. Might switch to probit. Instrumenting for flood insurance takeup. Data represents the set of homes in each census tract x flood zone x year of construction. Includes home set and year fixed effects. Will likely add (or swap in) census tract (or county) fixed effects for the spatial FEs. Clustering on the spacial fixed effects.

Coefficients of interest for each question:

1. `flood_eventTRUE`, `flood_L1TRUE`, `flood_L2TRUE`, `flood_L3TRUE`
2. `flood_eventTRUE:policy_prob`, `flood_L1TRUE:policy_prob_L1`, `flood_L2TRUE:policy_prob_L2`, `flood_L3TRUE:policy_prob_L3`

Average transaction probability in our sample: 

```{r}
tzy_panel[in_sample == TRUE, mean(transaction_prob)]
```

# Results

# Two Lags, no Leads

```{r event-study-2-noF}
ols_res <- plm(transaction_prob ~ flood_event * policy_prob + flood_L1 * policy_prob_L1
                                  + flood_L2 * policy_prob_L2
                                  | flood_event * reg_reform:adapted + flood_L1 * reg_reform_L1:adapted
                                    + flood_L2 * reg_reform_L2:adapted,
               data = tzy_panel[in_sample == TRUE], model = "within", index = c("panel_id", "year"), effect = "twoway")
summary(ols_res, vcov=vcovHC(ols_res, type="HC1", cluster="group"))
# summary(ols_res)
```

# Three Lags, No Leads

```{r event-study-3-noF}
ols_res <- plm(transaction_prob ~ flood_event * policy_prob + flood_L1 * policy_prob_L1
                                  + flood_L2 * policy_prob_L2 + flood_L3 * policy_prob_L3
                                  | flood_event * reg_reform:adapted + flood_L1 * reg_reform_L1:adapted
                                    + flood_L2 * reg_reform_L2:adapted + flood_L3 * reg_reform_L3:adapted,
               data = tzy_panel[in_sample == TRUE], model = "within", index = c("panel_id", "year"), effect = "twoway")
summary(ols_res, vcov=vcovHC(ols_res, type="HC1", cluster="group"))
# summary(ols_res)
```

# Two Lags, One Lead

```{r event-study-2-F}
ols_res <- plm(transaction_prob ~ flood_event * policy_prob + flood_L1 * policy_prob_L1
                                  + flood_L2 * policy_prob_L2 + flood_F1 * policy_prob_F1
                                  | flood_event * reg_reform:adapted + flood_L1 * reg_reform_L1:adapted
                                    + flood_L2 * reg_reform_L2:adapted + flood_F1 * reg_reform_F1:adapted,
               data = tzy_panel[in_sample == TRUE], model = "within", index = c("panel_id", "year"), effect = "twoway")
summary(ols_res, vcov=vcovHC(ols_res, type="HC1", cluster="group"))
# summary(ols_res)
```

# Three Lags, One Lead

```{r event-study-3-F}
ols_res <- plm(transaction_prob ~ flood_event * policy_prob + flood_L1 * policy_prob_L1
                                  + flood_L2 * policy_prob_L2 + flood_L3 * policy_prob_L3 + flood_F1 * policy_prob_F1
                                  | flood_event * reg_reform:adapted + flood_L1 * reg_reform_L1:adapted
                                    + flood_L2 * reg_reform_L2:adapted + flood_L3 * reg_reform_L3:adapted + flood_F1 * reg_reform_F1:adapted,
               data = tzy_panel[in_sample == TRUE], model = "within", index = c("panel_id", "year"), effect = "twoway")
summary(ols_res, vcov=vcovHC(ols_res, type="HC1", cluster="group"))
# summary(ols_res)
```


```{r first-stage}
ols_res <- plm(transaction_prob ~ flood_event * policy_prob + flood_L1 * policy_prob_L1
                                  + flood_L2 * policy_prob_L2 + flood_F1 * policy_prob_F1,
               data = tzy_panel[in_sample == TRUE], model = "within", index = c("panel_id", "year"), effect = "twoway")
# summary(ols_res, vcov=vcovHC(ols_res, type="HC1", cluster="group"))
summary(ols_res)
```


# Conclusions
